name: Ultimate Docker Download

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'é•œåƒåç§°'
        required: true
        default: 'kaedei/dandanplay-library-index-server:latest'

jobs:
  download_and_package:
    runs-on: ubuntu-latest
    steps:
      - name: Try Pulling from Multiple Mirrors
        run: |
          IMAGE_NAME="${{ github.event.inputs.image_name }}"
          echo "ç›®æ ‡é•œåƒ: $IMAGE_NAME"
          
          # å®šä¹‰é•œåƒæºåˆ—è¡¨ (è¿™æ˜¯ç›®å‰è¿˜æ´»ç€çš„å‡ ä¸ª)
          MIRRORS=(
            "docker.1ms.run"
            "docker.ketches.cn"
            "docker.m.daocloud.io"
            "docker.1panel.live"
            "docker.hlyun.org"
            "docker.rainbond.cc"
            "docker.io"  # æœ€åå°è¯•ç›´è¿
          )

          SUCCESS=false

          for MIRROR in "${MIRRORS[@]}"; do
            if [ "$MIRROR" == "docker.io" ]; then
               FULL_URL="$IMAGE_NAME"
            else
               FULL_URL="$MIRROR/$IMAGE_NAME"
            fi
            
            echo "----------------------------------------"
            echo "æ­£åœ¨å°è¯•é•œåƒæº: $MIRROR ..."
            echo "æ‹‰å–åœ°å€: $FULL_URL"
            
            if docker pull "$FULL_URL"; then
              echo "âœ… æˆåŠŸä» $MIRROR æ‹‰å–ï¼"
              
              # å¦‚æœæ˜¯ä»ä»£ç†æ‹‰ä¸‹æ¥çš„ï¼Œæ”¹å›åŸå
              if [ "$MIRROR" != "docker.io" ]; then
                echo "æ­£åœ¨é‡å‘½åé•œåƒ..."
                docker tag "$FULL_URL" "$IMAGE_NAME"
                docker rmi "$FULL_URL"
              fi
              
              SUCCESS=true
              break
            else
              echo "âŒ å¤±è´¥ (å°è¯•ä¸‹ä¸€ä¸ª)..."
            fi
          done

          if [ "$SUCCESS" = false ]; then
            echo "ğŸ’€ æ‰€æœ‰é•œåƒæºéƒ½å¤±è´¥äº†ï¼Œå½»åº•æ²¡æ•‘äº†ã€‚"
            exit 1
          fi

      - name: Save to Tar
        run: |
          echo "æ­£åœ¨æ‰“åŒ…..."
          docker save -o dandanplay.tar ${{ github.event.inputs.image_name }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dandanplay-tar-package
          path: dandanplay.tar
          retention-days: 1
